# План разработки системы промокодов

## 1. Анализ требований (Q&A)

На основе ответов пользователя, формируем спецификацию функционала:

### Типы и Логика
*   **Базовые типы:**
    1.  **Процентная скидка** (например, `-10%`).
    2.  **Фиксированная сумма** (например, `-500₽`).
    3.  **Подарок** (автоматическое добавление товара в корзину за 0₽).
    4.  **Бесплатная доставка** (обнуление стоимости доставки).
    5.  **Амбассадор** (Личные коды партнеров. Работают как % или фикс, но с отдельным тегом для аналитики).
*   **Генерация:** Автоматическая по шаблонам (для массовых) + Ручной ввод (кастомные имена).
*   **Визуализация:** Все коды приводятся к верхнему регистру (CAPS), ввод нечувствителен к регистру.

### Ограничения
*   **Срок действия:** Диапазон дат (Start/End) или бессрочно (отключается вручную).
*   **Лимиты:** Общий лимит использований (Global Limit).
*   **Мин. сумма:** Возможность задать минимальную сумму заказа для активации.
*   **Пользователи:** Нет личных кабинетов -> нет лимитов "на одни руки" (реализация через LocalStorage/Cookies возможна, но ненадежна, поэтому отказываемся).
*   **Суммирование:** Не суммируются с другими акциями.
*   **Исключения:** Возможность исключать категории/товары.

### Управление и Аналитика
*   **Статус:** Активен / Неактивен.
*   **История:** Полный лог использования (Кто, Когда, Сумма).
*   **Mass Action:** Массовая генерация кодов.
*   **Тегирование:** Цветовая индикация типов (Амбассадор = Фиолетовый, Скидка = Зеленый и т.д.).
*   **Комментарии:** Внутренние заметки для админов.

### UX (Корзина)
*   **Вывод:**
    *   Подытог: 10 000₽
    *   Скидка (CODE20): -2 000₽
    *   Итого: 8 000₽
*   **Ошибки:** Детальные ("Сумма заказа меньше 5000₽", "Срок действия истек", "Лимит исчерпан").

---

## 2. Предложения по типам лояльности (дополнение к вопросу 1)

Помимо запрошенных, предлагаем рассмотреть следующие механики для будущих обновлений:

1.  **"1+1=3" (Only for specific items)**: При покупке двух определенных товаров, третий (самый дешевый) идет в подарок.
2.  **Bundle Discount (Комплект)**: Скидка при покупке "Худи + Штаны" вместе.
3.  **Flash Sale (Таймер)**: Код, который действует всего 1 час после активации (требует сессии), или жесткое время "Скидка до 12:00".
4.  **Secret Link (Авто-применение)**: Промокод, который не нужно вводить, он применяется при переходе по ссылке `?promo=AMBASSADOR`.

*В текущий роадмап включим: Процент, Фикс, Подарок, Доставка, Амбассадор.*

---

## 3. Roadmap разработки

Разработка разбита на 4 этапа.

### Этап 1: База данных (Backend)
**Задача:** Создать структуры данных для хранения правил и истории.

1.  Создать таблицу `promocodes`:
    *   `code` (unique, index)
    *   `type` (enum: percent, fixed, free_shipping, gift)
    *   `value` (amount/percentage/gift_product_id)
    *   `is_active` (boolean)
    *   `starts_at`, `expires_at` (nullable dates)
    *   `usage_limit` (int, nullable)
    *   `usage_count` (int, default 0)
    *   `min_order_amount` (int, nullable)
    *   `is_ambassador` (boolean) -> для фильтрации и тегов
    *   `admin_comment` (string)
    *   `constraints` (JSON: excluded_categories, included_products)
2.  Обновить таблицу `orders` (или создать связь):
    *   Добавить поле `promocode_id` (связь)
    *   Добавить поле `discount_amount` (фиксируем скидку в момент заказа)

### Этап 2: Админ-панель (UI/UX)
**Задача:** Интерфейс управления кодами.

1.  **Список промокодов:**
    *   Таблица с колонками: Код, Тип, Скидка, Использовано, Статус, Даты.
    *   Цветовые бейджи типов.
    *   Фильтры: Активные/Архив, Срок действия, Тип.
2.  **Форма создания/редактирования:**
    *   Генератор кода (Кнопка "Сгенерировать случайный").
    *   Выбор типа (Карточки с иконками).
    *   Настройка условий (Мин сумма, Даты, Лимиты).
    *   Блок исключений (Select товаров/категорий).
3.  **Массовые действия:**
    *   Модальное окно "Создать 50 кодов" с префиксом (например `NY2025-XXXX`).

### Этап 3: Логика применения (Business Logic)
**Задача:** API endpoint / Server Action для проверки кода.

1.  Функция `validatePromocode(code, cartTotal, cartItems)`:
    *   Проверка существования и активности.
    *   Проверка дат.
    *   Проверка лимита использований.
    *   Проверка мин. суммы.
    *   Расчет скидки с учетом исключений.
    *   Возврат: `{ isValid: boolean, discount: number, error?: string, type: string }`.

### Этап 4: Интеграция в Корзину (Frontend)
**Задача:** Поле ввода и пересчет итогов.

1.  Компонент `PromoCodeInput` в корзине.
2.  Отображение примененного кода и скидки отдельной строкой.
3.  Обработка ошибок (те самые детальные сообщения).
4.  Блокировка ввода, если код уже применен (так как суммирование запрещено).

### Этап 5: Финализация и Тесты
1.  Тест кейсов: истекший код, код с лимитом, код на категорию.
2.  Проверка записи в базу заказов.
