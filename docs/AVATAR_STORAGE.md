# üì∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
–ê–≤–∞—Ç–∞—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ö—Ä–∞–Ω—è—Ç—Å—è **–ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ** –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:
```
/public/uploads/avatars/
```

### –§–æ—Ä–º–∞—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
```
{userId}-{timestamp}.jpg
```
–ü—Ä–∏–º–µ—Ä: `550e8400-e29b-41d4-a716-446655440000-1768501143859.jpg`

---

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞ —Å–∏—Å—Ç–µ–º–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç** –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä
2. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞ –≤ –ë–î
3. –ï—Å–ª–∏ —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ `/public/uploads/avatars/`
4. –ù–æ–≤—ã–π —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
5. –ü—É—Ç—å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –ö–æ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
```typescript
import { saveAvatarFile } from "@/lib/avatar-storage";

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç —Å—Ç–∞—Ä—ã–π –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –Ω–æ–≤—ã–π
const avatarPath = await saveAvatarFile(
    buffer,           // Buffer —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
    userId,           // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    oldAvatarPath     // –ü—É—Ç—å –∫ —Å—Ç–∞—Ä–æ–º—É –∞–≤–∞—Ç–∞—Ä—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
);
```

---

## –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∏ –æ—á–∏—Å—Ç–∫–∞

### –°–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤

–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è "–æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏—Ö" —Ñ–∞–π–ª–æ–≤ (–∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –Ω–∏ –∫ –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é):

```bash
npx tsx scripts/cleanup-avatars.ts
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
- –°–∫–∞–Ω–∏—Ä—É–µ—Ç `/public/uploads/avatars/`
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å –∑–∞–ø–∏—Å—è–º–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `users`
- –£–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –í—ã–≤–æ–¥–∏—Ç –æ—Ç—á–µ—Ç –æ–± –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–Ω–æ–º –º–µ—Å—Ç–µ

**–ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å:**
- –ü–æ—Å–ª–µ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –†–∞–∑ –≤ –º–µ—Å—è—Ü –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏
- –ü—Ä–∏ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–∏ –Ω–∞ "–º—É—Å–æ—Ä–Ω—ã–µ" —Ñ–∞–π–ª—ã

---

## –ü–æ—á–µ–º—É –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ?

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- **–°–∫–æ—Ä–æ—Å—Ç—å**: –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫ S3
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –§–∞–π–ª—ã –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º —Å–µ—Ä–≤–µ—Ä–∞
- **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –ù–µ –Ω—É–∂–Ω—ã API –∫–ª—é—á–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

### S3 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
- –î–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞–∫–∞–∑–æ–≤ (PDF, –º–∞–∫–µ—Ç—ã)
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–∫—ç—à, —ç–∫—Å–ø–æ—Ä—Ç—ã)
- –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã (–∞—Ä—Ö–∏–≤—ã, –±—ç–∫–∞–ø—ã)

---

## API —Ñ—É–Ω–∫—Ü–∏–∏

### `saveAvatarFile(buffer, userId, oldAvatarPath?)`
–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä –∏ —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–π.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `buffer: Buffer` - –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- `userId: string` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `oldAvatarPath: string | null` - –ø—É—Ç—å –∫ —Å—Ç–∞—Ä–æ–º—É —Ñ–∞–π–ª—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `Promise<string>` - –ø—É—Ç—å –∫ –Ω–æ–≤–æ–º—É —Ñ–∞–π–ª—É

---

### `deleteAvatarFile(avatarPath)`
–£–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª –∞–≤–∞—Ç–∞—Ä–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `avatarPath: string | null` - –ø—É—Ç—å –≤–∏–¥–∞ `/uploads/avatars/file.jpg`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `boolean` - —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∏—è

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
```typescript
// app/dashboard/profile/actions.ts
const buffer = Buffer.from(await avatarFile.arrayBuffer());
const currentUser = await db.query.users.findFirst({
    where: eq(users.id, session.id),
    columns: { avatar: true }
});

updateData.avatar = await saveAvatarFile(
    buffer,
    session.id,
    currentUser?.avatar || null
);
```

### –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–≤–∞—Ç–∞—Ä–æ–º
```typescript
import { deleteAvatarFile } from "@/lib/avatar-storage";

const user = await db.query.users.findFirst({
    where: eq(users.id, userId)
});

// –£–¥–∞–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if (user?.avatar) {
    deleteAvatarFile(user.avatar);
}

await db.delete(users).where(eq(users.id, userId));
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
```bash
ssh root@89.104.69.25
du -sh /root/merch-crm/public/uploads/avatars/
```

### –ü–æ–¥—Å—á–µ—Ç —Ñ–∞–π–ª–æ–≤
```bash
ls -1 /root/merch-crm/public/uploads/avatars/ | wc -l
```

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ê–≤–∞—Ç–∞—Ä –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –≤ –ë–î: `SELECT avatar FROM users WHERE id = '...'`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: `ls public/uploads/avatars/`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: `chmod 755 public/uploads/avatars/`

### –ü—Ä–æ–±–ª–µ–º–∞: –°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏: `npx tsx scripts/cleanup-avatars.ts`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å Node.js –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å

---

## –ë—ç–∫–∞–ø

–ê–≤–∞—Ç–∞—Ä—ã –≤–∫–ª—é—á–µ–Ω—ã –≤ –æ–±—â–∏–π –±—ç–∫–∞–ø —Å–µ—Ä–≤–µ—Ä–∞. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∞—Ä—Ö–∏–≤:

```bash
cd /root/merch-crm/public/uploads
tar -czf avatars-backup-$(date +%Y%m%d).tar.gz avatars/
```
