import { NextRequest, NextResponse } from "next/server";
import { jwtVerify } from "jose";

const SECRET_KEY = process.env.JWT_SECRET_KEY;
const key = SECRET_KEY ? new TextEncoder().encode(SECRET_KEY) : null;

/** Paths accessible without authentication */
const PUBLIC_PATHS = [
    "/login",
    "/api/auth/login",
    "/api/auth/logout",
    "/api/health",
];

/** Paths that should be completely skipped by middleware (static assets, etc.) */
const SKIP_PATHS = [
    "/_next",
    "/favicon.ico",
    "/manifest.json",
    "/robots.txt",
    "/sitemap.xml",
];

function isPublicPath(pathname: string): boolean {
    return PUBLIC_PATHS.some((p) => pathname === p || pathname.startsWith(p + "/"));
}

function isSkipPath(pathname: string): boolean {
    return SKIP_PATHS.some((p) => pathname.startsWith(p));
}

export async function middleware(req: NextRequest) {
    const { pathname } = req.nextUrl;
    console.log(`[Middleware] Processing request for: ${pathname}`);
    if (!key && !isPublicPath(pathname) && !isSkipPath(pathname)) {
        console.error("[Middleware] JWT_SECRET_KEY is not configured");
    }
    return NextResponse.next();
}

export const config = {
    matcher: [
        /*
         * Match all request paths except:
         * - _next/static (static files)
         * - _next/image (image optimization)
         * - favicon.ico, robots.txt, etc.
         */
        "/((?!_next/static|_next/image|favicon.ico).*)",
    ],
};
