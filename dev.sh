#!/bin/bash

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—É–Ω–Ω–µ–ª–µ–π –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
cleanup() {
    echo ""
    echo "üîå –ó–∞–∫—Ä—ã–≤–∞—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö..."
    lsof -ti:5432 | xargs kill -9 2>/dev/null
    exit
}

# –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º Ctrl+C
trap cleanup SIGINT

echo "üîÑ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ç—É–Ω–Ω–µ–ª–∏ –Ω–∞ 5432 –ø–æ—Ä—Ç—É
if lsof -Pi :5432 -sTCP:LISTEN -t >/dev/null ; then
    echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 5432 –∑–∞–Ω—è—Ç. –û—Å–≤–æ–±–æ–∂–¥–∞—é..."
    lsof -ti:5432 | xargs kill -9 2>/dev/null
fi

# 2. –ó–∞–ø—É—Å–∫–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å
echo "üîó –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É..."
ssh -i ~/.ssh/antigravity_key -f -N -L 5432:localhost:5432 root@89.104.69.25

if [ $? -eq 0 ]; then
    echo "‚úÖ –°–≤—è–∑—å —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ VPN –∏–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç."
    exit 1
fi

# 3. –ó–∞–ø—É—Å–∫–∞–µ–º Next.js
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é MerchCRM..."
npm run dev

# –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ (–µ—Å–ª–∏ npm run dev —É–ø–∞–¥–µ—Ç —Å–∞–º) —Ç–æ–∂–µ —á–∏—Å—Ç–∏–º
cleanup
